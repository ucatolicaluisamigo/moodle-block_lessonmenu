define("block_lessonmenu/structureeditor",["exports","jquery","core/sortable_list","core/log","core/modal_factory","core/str","core/notification"],function(_exports,_jquery,_sortable_list,_log,_modal_factory,_str,_notification){function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}
/**
   * Module structureeditor
   *
   * @module     block_lessonmenu/structureeditor
   * @copyright  2025 David Herney @ BambuCo
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_sortable_list=_interopRequireDefault(_sortable_list),_log=_interopRequireDefault(_log),_modal_factory=_interopRequireDefault(_modal_factory),_notification=_interopRequireDefault(_notification);var strings=[{key:"changecontenttype",component:"block_lessonmenu"},{key:"invalidindentation",component:"block_lessonmenu"},{key:"invalidindentationtitle",component:"block_lessonmenu"}],s=[];_exports.init=async()=>{const $editorContainer=(0,_jquery.default)("#lessonmenu-editor");if(0===$editorContainer.length)return;var changeTypeModal;await(strings.forEach(one=>{s[one.key]=one.key}),new Promise(resolve=>{(0,_str.get_strings)(strings).then(function(results){var pos=0;return strings.forEach(one=>{s[one.key]=results[pos],pos++}),resolve(!0),!0}).fail(function(e){return _log.default.debug("Error loading strings"),_log.default.debug(e),!1})})).catch(()=>null);var $currentItem=null;new _sortable_list.default("#lessonmenu-editor",{targetListSelector:null,moveHandlerSelector:"[data-drag-type=move]",isHorizontal:!1,autoScroll:!0}).getElementType=element=>_jquery.default.Deferred().resolve(element.attr("data-type")),(0,_jquery.default)('#lessonmenu-edit-structure-actions [data-action="adddefaultsections"]').on("click",event=>{event.preventDefault();const selectedvalue=(0,_jquery.default)("#lessonmenu-add-defaultsections select").val(),values=JSON.parse(selectedvalue);if(values&&values.length>0){values.forEach(title=>{const $newitem=newSection(title);null!==$newitem&&$editorContainer.append($newitem)});const $inputs=$editorContainer.find('input[type="text"]');$inputs.length&&$inputs.last()[0].focus()}else _log.default.debug("No sections selected to add.")}),(0,_jquery.default)('#lessonmenu-edit-structure-actions [data-action="addsection"]').on("click",event=>{event.preventDefault();const $newitem=newSection("");null!==$newitem&&($editorContainer.append($newitem),$newitem.find('input[type="text"]')[0].focus())}),(0,_jquery.default)('#lessonmenu-edit-structure-actions [data-action="deletesection"]').on("click",event=>{event.preventDefault(),deletesection(event)}),$editorContainer.find(".item-icon").on("click",event=>{event.preventDefault();const $item=(0,_jquery.default)(event.currentTarget).closest('[data-type="page"]');$item.length&&(changeTypeModal.show(),$currentItem=$item)}),$editorContainer.find('[data-action="moveright"]').on("click",event=>{event.preventDefault();const $item=(0,_jquery.default)(event.currentTarget).closest('[data-type="page"]');if(!$item.length)return;const $prevItem=$item.prev('[data-type="page"]');let indentation=$item.data("indentation")||0;if(0===$prevItem.length||$prevItem.data("indentation")-indentation<0)return;indentation+=1,setIdentation($item,indentation);let $nextItem=$item.next('[data-type="page"]');for(;$nextItem&&$nextItem.length;){const nextIndentation=$nextItem.data("indentation")||0;if(nextIndentation<=indentation-1)break;setIdentation($nextItem,nextIndentation+1),$nextItem=$nextItem.next('[data-type="page"]')}}),$editorContainer.find('[data-action="moveleft"]').on("click",event=>{event.preventDefault();const $item=(0,_jquery.default)(event.currentTarget).closest('[data-type="page"]');if(!$item.length)return;let indentation=$item.data("indentation")||0;if(0==indentation)return;indentation-=1,setIdentation($item,indentation);let $nextItem=$item.next('[data-type="page"]');for(;$nextItem&&$nextItem.length;){const nextIndentation=$nextItem.data("indentation")||0;if(nextIndentation<=indentation+1)break;setIdentation($nextItem,nextIndentation-1),$nextItem=$nextItem.next('[data-type="page"]')}}),(0,_jquery.default)('#lessonmenu-edit-structure-actions [data-action="save"]').on("click",event=>{event.preventDefault();let menuitems=[],section={title:null,items:[]};menuitems.push(section);let indentation=-1;$editorContainer.find('[data-type="section"], [data-type="page"]').each((index,element)=>{const $element=(0,_jquery.default)(element);if("section"===$element.data("type")){const sectiontitle=$element.find('input[type="text"]').val();if(!sectiontitle||""===sectiontitle.trim())return;return section={title:sectiontitle,items:[]},menuitems.push(section),void(indentation=-1)}if("page"===$element.data("type")){let item={pageid:$element.data("pageid"),contenttype:$element.data("contenttype"),duration:$element.find('[data-action="duration"] input').val(),indentation:$element.data("indentation")};if(""===item.duration||isNaN(item.duration)||item.duration<0?item.duration=0:item.duration=parseInt(item.duration,10),item.indentation-indentation>1)throw _notification.default.alert(s.invalidindentationtitle,s.invalidindentation+" ("+$element.find(".item-title").text()+")"),new Error("Invalid indentation for item: "+$element.find(".item-title").text());return indentation=item.indentation,void section.items.push(item)}});(0,_jquery.default)('textarea[name="structure"]').val(JSON.stringify(menuitems));(0,_jquery.default)("#lessonmenu-edit-structure-form").trigger("submit")}),$editorContainer.find('[data-type="page"]').each((index,element)=>{const $element=(0,_jquery.default)(element),indentation=$element.data("indentation")||0;setIdentation($element,indentation)});const $iconModal=(0,_jquery.default)("#lessonmenu-change-icon-modal");_modal_factory.default.create({type:_modal_factory.default.types.CANCEL,body:$iconModal.html(),title:s.changecontenttype}).then(function(modal){return changeTypeModal=modal,modal.getRoot().find("#lessonmenu-change-icon-select > li").on("click",event=>{event.preventDefault();const $selected=(0,_jquery.default)(event.currentTarget),code=$selected.data("value");if($currentItem&&code){const $iconspan=$currentItem.find(".item-icon");$iconspan.length&&($iconspan.html($selected.find("> span").html()),$iconspan.attr("title",$selected.find("> span").attr("title")||"")),$currentItem.attr("data-contenttype",code),$currentItem.data("contenttype",code)}$currentItem=null,modal.hide()}),modal}).fail(function(){_log.default.error("Error creating change content type modal")})};const deletesection=event=>{event.preventDefault();const $section=(0,_jquery.default)(event.currentTarget).closest('[data-type="section"]');$section.length&&$section.remove()},newSection=title=>{const $tplsection=(0,_jquery.default)('[data-tpl="section"]');if(0===$tplsection.length)return _log.default.debug("Template for section not found."),null;let contentsection=$tplsection.html();contentsection=contentsection.replace(/\[title\]/g,title);const $newitem=(0,_jquery.default)(contentsection);return $newitem.find('[data-action="deletesection"]').on("click",event=>{deletesection(event)}),$newitem},setIdentation=($item,indentation)=>{$item.data("indentation",indentation),$item.attr("data-indentation",indentation),$item.css("padding-left",20*(indentation+1)+"px")}});

//# sourceMappingURL=structureeditor.min.js.map