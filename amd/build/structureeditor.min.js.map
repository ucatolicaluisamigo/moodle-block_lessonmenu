{"version":3,"file":"structureeditor.min.js","sources":["../src/structureeditor.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module structureeditor\n *\n * @module     block_lessonmenu/structureeditor\n * @copyright  2025 David Herney @ BambuCo\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport SortableList from 'core/sortable_list';\nimport Log from 'core/log';\nimport ModalFactory from 'core/modal_factory';\nimport {get_strings as getStrings} from 'core/str';\n\n// Load strings.\nvar strings = [\n    {key: 'changecontenttype', component: 'block_lessonmenu'},\n];\nvar s = [];\n\n/**\n * Load strings from server.\n *\n * @return {Promise} Promise that is resolved when the strings are loaded.\n */\nfunction loadStrings() {\n\n    strings.forEach(one => {\n        s[one.key] = one.key;\n    });\n\n    return new Promise((resolve) => {\n        getStrings(strings).then(function(results) {\n            var pos = 0;\n            strings.forEach(one => {\n                s[one.key] = results[pos];\n                pos++;\n            });\n\n            resolve(true);\n            return true;\n        }).fail(function(e) {\n            Log.debug('Error loading strings');\n            Log.debug(e);\n            return false;\n        });\n    });\n}\n// End of Load strings.\n\n/**\n * Initialize the structure editor.\n */\nexport const init = async() => {\n    const editorSelector = '#lessonmenu-editor';\n    const $editorContainer = $(editorSelector);\n    if ($editorContainer.length === 0) {\n        return;\n    }\n\n    await loadStrings().catch(() => null);\n\n    var changeTypeModal;\n    var $currentItem = null;\n\n    var config = {\n        targetListSelector: null,\n        moveHandlerSelector: '[data-drag-type=move]',\n        isHorizontal: false,\n        autoScroll: true\n    };\n    const list = new SortableList(editorSelector, config);\n\n    list.getElementType = element => {\n        return $.Deferred().resolve(element.attr('data-type'));\n    };\n\n    $('#lessonmenu-edit-structure-actions [data-action=\"adddefaultsections\"]').on('click', event => {\n        event.preventDefault();\n        const selectedvalue = $('#lessonmenu-add-defaultsections select').val();\n        const values = JSON.parse(selectedvalue);\n        if (values && values.length > 0) {\n            values.forEach(title => {\n                const $newitem = newSection(title);\n                if ($newitem === null) {\n                    return;\n                }\n                $editorContainer.append($newitem);\n            });\n            const $inputs = $editorContainer.find('input[type=\"text\"]');\n            if ($inputs.length) {\n                $inputs.last()[0].focus();\n            }\n\n        } else {\n            Log.debug('No sections selected to add.');\n        }\n    });\n\n    $('#lessonmenu-edit-structure-actions [data-action=\"addsection\"]').on('click', event => {\n        event.preventDefault();\n\n        const $newitem = newSection('');\n        if ($newitem === null) {\n            return;\n        }\n        $editorContainer.append($newitem);\n        $newitem.find('input[type=\"text\"]')[0].focus();\n    });\n\n    $('#lessonmenu-edit-structure-actions [data-action=\"deletesection\"]').on('click', event => {\n        event.preventDefault();\n        deletesection(event);\n    });\n\n    // Change the content type.\n    $editorContainer.find('.item-icon').on('click', event => {\n        event.preventDefault();\n        const $iconspan = $(event.currentTarget);\n        const $item = $iconspan.closest('[data-type=\"page\"]');\n        if ($item.length) {\n            changeTypeModal.show();\n            $currentItem = $item;\n        }\n    });\n\n    // Create the change content type modal.\n    const $iconModal = $('#lessonmenu-change-icon-modal');\n    ModalFactory.create({\n        type: ModalFactory.types.CANCEL,\n        body: $iconModal.html(),\n        title: s.changecontenttype,\n    })\n    .then(function(modal) {\n        changeTypeModal = modal;\n\n        modal.getRoot().find('#lessonmenu-change-icon-select > li').on('click', event => {\n            event.preventDefault();\n            const $selected = $(event.currentTarget);\n            const code = $selected.attr('value');\n\n            if ($currentItem && code) {\n                // Update the item icon.\n                const $iconspan = $currentItem.find('.item-icon');\n                if ($iconspan.length) {\n                    $iconspan.html($selected.find('> span').html());\n                    $iconspan.attr('title', $selected.find('> span').attr('title') || '');\n                }\n                // Update the data attribute.\n                $currentItem.attr('data-contenttype', code);\n            }\n\n            $currentItem = null;\n            modal.hide();\n        });\n\n        return modal;\n    })\n    .fail(function() {\n        Log.error('Error creating change content type modal');\n    });\n};\n\n/**\n * Delete a section.\n *\n * @param {object} event\n */\nconst deletesection = (event) => {\n    event.preventDefault();\n    const $section = $(event.currentTarget).closest('[data-type=\"section\"]');\n    if ($section.length) {\n        $section.remove();\n    }\n};\n\n/**\n * Create a new section.\n *\n * @param {string} title\n * @returns {jQuery|null}\n */\nconst newSection = (title) => {\n    const $tplsection = $('[data-tpl=\"section\"]');\n    if ($tplsection.length === 0) {\n        Log.debug('Template for section not found.');\n        return null;\n    }\n    let contentsection = $tplsection.html();\n    contentsection = contentsection.replace(/\\[title\\]/g, title);\n    const $newitem = $(contentsection);\n    $newitem.find('[data-action=\"deletesection\"]').on('click', event => {\n        deletesection(event);\n    });\n    return $newitem;\n};\n"],"names":["strings","key","component","s","async","$editorContainer","length","changeTypeModal","forEach","one","Promise","resolve","then","results","pos","fail","e","debug","catch","$currentItem","SortableList","targetListSelector","moveHandlerSelector","isHorizontal","autoScroll","getElementType","element","$","Deferred","attr","on","event","preventDefault","selectedvalue","val","values","JSON","parse","title","$newitem","newSection","append","$inputs","find","last","focus","deletesection","$item","currentTarget","closest","show","$iconModal","create","type","ModalFactory","types","CANCEL","body","html","changecontenttype","modal","getRoot","$selected","code","$iconspan","hide","error","$section","remove","$tplsection","contentsection","replace"],"mappings":";;;;;;;4QA6BIA,QAAU,CACV,CAACC,IAAK,oBAAqBC,UAAW,qBAEtCC,EAAI,iBAmCYC,gBAEVC,kBAAmB,mBADF,yBAES,IAA5BA,iBAAiBC,kBAMjBC,sBAnCJP,QAAQQ,SAAQC,MACZN,EAAEM,IAAIR,KAAOQ,IAAIR,OAGd,IAAIS,SAASC,+BACLX,SAASY,MAAK,SAASC,aAC1BC,IAAM,SACVd,QAAQQ,SAAQC,MACZN,EAAEM,IAAIR,KAAOY,QAAQC,KACrBA,SAGJH,SAAQ,IACD,KACRI,MAAK,SAASC,uBACTC,MAAM,sCACNA,MAAMD,IACH,SAgBKE,OAAM,IAAM,WAG5BC,aAAe,KAQN,IAAIC,uBAjBM,qBAWV,CACTC,mBAAoB,KACpBC,oBAAqB,wBACrBC,cAAc,EACdC,YAAY,IAIXC,eAAiBC,SACXC,gBAAEC,WAAWjB,QAAQe,QAAQG,KAAK,kCAG3C,yEAAyEC,GAAG,SAASC,QACnFA,MAAMC,uBACAC,eAAgB,mBAAE,0CAA0CC,MAC5DC,OAASC,KAAKC,MAAMJ,kBACtBE,QAAUA,OAAO7B,OAAS,EAAG,CAC7B6B,OAAO3B,SAAQ8B,cACLC,SAAWC,WAAWF,OACX,OAAbC,UAGJlC,iBAAiBoC,OAAOF,mBAEtBG,QAAUrC,iBAAiBsC,KAAK,sBAClCD,QAAQpC,QACRoC,QAAQE,OAAO,GAAGC,0BAIlB5B,MAAM,uDAIhB,iEAAiEa,GAAG,SAASC,QAC3EA,MAAMC,uBAEAO,SAAWC,WAAW,IACX,OAAbD,WAGJlC,iBAAiBoC,OAAOF,UACxBA,SAASI,KAAK,sBAAsB,GAAGE,gCAGzC,oEAAoEf,GAAG,SAASC,QAC9EA,MAAMC,iBACNc,cAAcf,UAIlB1B,iBAAiBsC,KAAK,cAAcb,GAAG,SAASC,QAC5CA,MAAMC,uBAEAe,OADY,mBAAEhB,MAAMiB,eACFC,QAAQ,sBAC5BF,MAAMzC,SACNC,gBAAgB2C,OAChB/B,aAAe4B,gBAKjBI,YAAa,mBAAE,wDACRC,OAAO,CAChBC,KAAMC,uBAAaC,MAAMC,OACzBC,KAAMN,WAAWO,OACjBpB,MAAOnC,EAAEwD,oBAEZ/C,MAAK,SAASgD,cACXrD,gBAAkBqD,MAElBA,MAAMC,UAAUlB,KAAK,uCAAuCb,GAAG,SAASC,QACpEA,MAAMC,uBACA8B,WAAY,mBAAE/B,MAAMiB,eACpBe,KAAOD,UAAUjC,KAAK,YAExBV,cAAgB4C,KAAM,OAEhBC,UAAY7C,aAAawB,KAAK,cAChCqB,UAAU1D,SACV0D,UAAUN,KAAKI,UAAUnB,KAAK,UAAUe,QACxCM,UAAUnC,KAAK,QAASiC,UAAUnB,KAAK,UAAUd,KAAK,UAAY,KAGtEV,aAAaU,KAAK,mBAAoBkC,MAG1C5C,aAAe,KACfyC,MAAMK,UAGHL,SAEV7C,MAAK,wBACEmD,MAAM,sDASZpB,cAAiBf,QACnBA,MAAMC,uBACAmC,UAAW,mBAAEpC,MAAMiB,eAAeC,QAAQ,yBAC5CkB,SAAS7D,QACT6D,SAASC,UAUX5B,WAAcF,cACV+B,aAAc,mBAAE,2BACK,IAAvBA,YAAY/D,2BACRW,MAAM,mCACH,SAEPqD,eAAiBD,YAAYX,OACjCY,eAAiBA,eAAeC,QAAQ,aAAcjC,aAChDC,UAAW,mBAAE+B,uBACnB/B,SAASI,KAAK,iCAAiCb,GAAG,SAASC,QACvDe,cAAcf,UAEXQ"}